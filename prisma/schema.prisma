// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}



// Prisma Schema for Event Manager Database
// This schema matches the existing PostgreSQL database structure defined in db/init/02_event_manager_db_schema.sql

// Enums
enum AttendeeStatus {
  RSVPed
  Maybe
  NotGoing

  @@map("attendee_status")
}

enum InvitationStatus {
  Active
  Expired
  Revoked

  @@map("invitation_status")
}

enum PaymentStatus {
  created
  processing
  succeeded
  failed
  canceled

  @@map("payment_status")
}

model Category {
  categoryId    String   @id @default(uuid()) @db.Uuid @map("category_id")
  categoryName  String   @db.VarChar(50) @map("category_name")
  description   String?  @db.Text

  // Relations
  events        Event[]

  @@map("categories")
}

model Event {
  eventId       String   @id @default(uuid()) @db.Uuid @map("event_id")
  eventName     String   @db.VarChar(100) @map("event_name")
  eventDatetime DateTime @map("event_datetime") @db.Timestamptz(6)
  eventEndtime  DateTime @map("event_endtime") @db.Timestamptz(6)
  eventLocation String?   @db.VarChar(255) @map("event_location")
  description   String?   @db.Text
  pictureUrl    String?   @db.VarChar(255) @map("picture_url")
  capacity      Int?
  priceField    Int?      @map("price_field")
  seriesId      String?   @db.Uuid @map("series_id")
  isRecurring   Boolean   @default(false) @map("is_recurring")
  recurrenceKind String?  @db.VarChar(20) @map("recurrence_kind")
  recurrenceInterval Int? @map("recurrence_interval")
  recurrenceWeekdays String? @db.VarChar(32) @map("recurrence_weekdays")
  recurrenceUntil DateTime? @db.Timestamptz(6) @map("recurrence_until")
  occurrenceIndex Int?    @map("occurrence_index")
  isSeriesMaster Boolean  @default(false) @map("is_series_master")
  userId        String   @map("user_id") @db.Uuid
  categoryId    String   @map("category_id") @db.Uuid
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  // Relations
  category      Category          @relation(fields: [categoryId], references: [categoryId])
  attendees     EventAttendee[]
  invitations   Invitation[]
  payments      Payment[]

  @@map("events")
}

model EventAttendee {
  attendeeId    String         @id @default(uuid()) @db.Uuid @map("attendee_id")
  eventId       String         @map("event_id") @db.Uuid
  userId        String         @map("user_id") @db.Uuid
  status        AttendeeStatus?
  createdAt     DateTime       @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt     DateTime       @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  // Relations
  event         Event          @relation(fields: [eventId], references: [eventId], onDelete: Cascade)

  @@map("eventattendees")
}

model Invitation {
  invitationId  String           @id @default(uuid()) @db.Uuid @map("invitation_id")
  eventId       String           @map("event_id") @db.Uuid
  userId        String           @map("user_id") @db.Uuid
  expiresAt     DateTime         @map("expires_at") @db.Timestamptz(6)
  tokenHash     String           @unique @db.VarChar(64) @map("token_hash")
  maxClaims     Int              @default(0) @map("max_claims")
  claimedCount  Int              @default(0) @map("claimed_count")
  status        InvitationStatus
  createdAt     DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime         @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  event         Event           @relation(fields: [eventId], references: [eventId], onDelete: Cascade)
  claims        InvitationClaim[]

  @@map("invitations")
}

model InvitationClaim {
  invitationClaimId String     @id @default(uuid()) @db.Uuid @map("invitation_claim_id")
  invitationId      String     @map("invitation_id") @db.Uuid
  claimedByUserId   String     @map("claimed_by_user_id") @db.Uuid
  createdAt         DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  invitation        Invitation @relation(fields: [invitationId], references: [invitationId], onDelete: Cascade)

  @@unique([invitationId, claimedByUserId])
  @@map("invitation_claims")
}

model Payment {
  paymentId           String        @id @default(uuid()) @db.Uuid @map("payment_id")
  eventId             String       @map("event_id") @db.Uuid
  userId              String       @map("user_id") @db.Uuid
  amountEtb           Decimal      @db.Decimal(10, 2) @map("amount_etb")
  currency            String        @default("ETB") @db.VarChar(10)
  status              PaymentStatus @default(created)
  telebirrPrepayId    String?       @db.VarChar(128) @map("telebirr_prepay_id")
  telebirrCheckoutUrl String?       @db.VarChar(512) @map("telebirr_checkout_url")
  createdAt           DateTime      @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt           DateTime      @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  // Relations
  event               Event         @relation(fields: [eventId], references: [eventId], onDelete: Cascade)

  @@map("payments")
}